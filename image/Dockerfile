FROM debian:stretch-slim
LABEL maintainer "Erwin Mueller <erwin.mueller@deventm.com>"

ARG APT_CACHE

RUN set -x \
  # Optional add proxy entries for apt.
  && if [ -n "${APT_CACHE}" ]; then \
  echo Acquire::ftp::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  echo Acquire::http::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  echo Acquire::https::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  fi

RUN set -x \
  && export DEBIAN_FRONTEND noninteractive \
  && apt-get update \
  && apt-get install -y \
  sudo openssh-server rsync locales unzip \
  && rm -rf /var/lib/apt/lists/* \
  && locale-gen en_US.UTF-8 \
  && dpkg-reconfigure locales

RUN set -x \
  # To avoid annoying "perl: warning: Setting locale failed." errors,
  # do not allow the client to pass custom locals, see:
  # http://stackoverflow.com/a/2510548/15677
  && sed -i 's/^AcceptEnv LANG LC_\*$//g' /etc/ssh/sshd_config \
  # http://stackoverflow.com/questions/22547939/docker-gitlab-container-ssh-git-login-error
  && sed -i '/session    required     pam_loginuid.so/d' /etc/pam.d/sshd \
  && mkdir /var/run/sshd \
  && addgroup --gid 200 rsync \
  && adduser --uid 200 --gid 200 --system --home /home/rsync --shell /bin/sh rsync \
  && chown -R rsync:rsync /home/rsync \
  && chmod o+rwX /run \
  # Remove SSH host keys, so they will be generated by /init
  && rm -f /etc/ssh/ssh_host_*

ENV RSYNC_ROOT="/var/rsync" \
  RSYNC_USERNAME="rsync" \
  RSYNC_PASSWORD="rsync" \
  RSYNC_HOSTS_ALLOW="*" \
  RSYNC_SSH_PORT="2222" \
  RSYNC_STRICT_HOST_KEY_CHECKING_NO="false" \
  DATA_DIR="/data" \
  USER="rsync" \
  RSYNC_CHOWN="false" \
  RSYNC_CHMOD="false" \
  DEBUG_SCRIPTS="false"

ADD rootfs/ /

RUN set -x \
  && mkdir -p ${RSYNC_ROOT} \
  && chmod o+w ${RSYNC_ROOT} \
  && mkdir -p ${DATA_DIR} \
  && chmod +x /*.sh \
  && chown -R rsync:rsync /etc/ssh

# Ssh port.
EXPOSE 2222

USER root

WORKDIR /data

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["/usr/sbin/sshd", "-D", "-e"]
