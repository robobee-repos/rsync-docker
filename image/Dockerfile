FROM debian:stretch-slim
LABEL maintainer "Erwin Mueller <erwin.mueller@deventm.com>"

ENV DEBIAN_FRONTEND noninteractive
ENV RSYNC_ROOT /var/rsync
ENV RSYNC_USERNAME rsync
ENV RSYNC_PASSWORD rsync
ENV RSYNC_HOSTS_ALLOW "*"
ENV DATA_DIR /data
ARG APT_CACHE

RUN set -x \
  # Optional add proxy entries for apt.
  && if [ -n "${APT_CACHE}" ]; then \
  echo Acquire::ftp::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  echo Acquire::http::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  echo Acquire::https::Proxy \"$APT_CACHE\"; >> /etc/apt/apt.conf.d/08proxy;\
  fi

RUN set -x \
  && apt-get update \
  && apt-get upgrade -y \
  && apt-get install -y \
  sudo openssh-server rsync locales \
  && rm -rf /var/lib/apt/lists/* \
  && locale-gen en_US.UTF-8 \
  && dpkg-reconfigure locales

RUN set -x \
  # To avoid annoying "perl: warning: Setting locale failed." errors,
  # do not allow the client to pass custom locals, see:
  # http://stackoverflow.com/a/2510548/15677
  && sed -i 's/^AcceptEnv LANG LC_\*$//g' /etc/ssh/sshd_config \
  # http://stackoverflow.com/questions/22547939/docker-gitlab-container-ssh-git-login-error
  && sed -i '/session    required     pam_loginuid.so/d' /etc/pam.d/sshd \
  && mkdir /var/run/sshd \
  && addgroup --gid 200 rsync \
  && adduser --uid 200 --gid 200 --system --home /home/rsync --shell /bin/sh rsync \
  && chown -R rsync:rsync /home/rsync \
  # Remove SSH host keys, so they will be generated by /init
  && rm -f /etc/ssh/ssh_host_*

# Root and data directory

RUN set -x \
  && mkdir -p ${RSYNC_ROOT} \
  && chmod o+w ${RSYNC_ROOT} \
  && mkdir -p ${DATA_DIR}

VOLUME /etc/ssh-in
VOLUME ${DATA_DIR}

# Rsync port.

EXPOSE 8873

# Rsync port.

EXPOSE 2222

# Finishing up.

ADD rootfs/docker-entrypoint.sh /docker-entrypoint.sh
ADD rootfs/init.sh /init.sh

RUN set -x \
  && chmod +x /docker-entrypoint.sh \
  && chmod +x /init.sh \
  && chown -R rsync:rsync /etc/ssh

USER rsync

WORKDIR /data

ENV USER rsync

ENV DEBUG_SCRIPTS false

ENTRYPOINT ["/docker-entrypoint.sh"]

CMD ["/usr/sbin/sshd", "-D"]
